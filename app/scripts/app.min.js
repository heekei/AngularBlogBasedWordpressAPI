/**
 * app.js 123
 */
'use strict';
angular.module('blogOnAngularJsApp', [
    'ngAnimate',
    'ngCookies',
    'ngResource',
    'ngSanitize',
    'ngTouch',
    'ui.router',
    "treeControl",
    "ui.bootstrap",
    'angular-loading-bar',
    'PostPageModule',
    'PagesModule',
    'CategoriesModule',
    'aboutModule'
])
    .run(['$rootScope', '$state', '$stateParams',
        function ($rootScope, $state, $stateParams) {
            $rootScope.$state = $state;
            $rootScope.$stateParams = $stateParams;
        }
    ])
    .config(['$stateProvider', '$urlRouterProvider', 'cfpLoadingBarProvider', function ($stateProvider, $urlRouterProvider, cfpLoadingBarProvider) {
        cfpLoadingBarProvider.spinnerTemplate = '<div><span class="fa fa-spinner"><div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div></div>';
        $urlRouterProvider
            .when("", "/")
            .when("/post", "/")
            // .when("/page", "/")
            .otherwise("/NotFound");
        $stateProvider
            .state('home', {
                url: '/',
                title: '首页',
                controller: function ($state) {
                    $state.go("page", { pageid: 1 }, { location: false });
                }
            })
            /*分类页面*/
            .state('category', {
                url: '/category?cid&pageid',
                templateUrl: 'views/pages.html',
                controller: 'CategoriesController'
            })
            /*文章列表*/
            .state('page', {
                url: '/page?pageid',
                templateUrl: 'views/pages.html',
                controller: 'PagesController'
            })
            /*文章页*/
            .state('post', {
                url: "/post/{pid}",
                templateUrl: 'views/post_tpl.html',
                controller: 'postView'
            })
            ;
    }])
    .directive('getPosts', ['$http', function ($http) {
        return {
            restrict: "E",
            replace: true,
            templateUrl: 'views/get_posts_tpl.html',
            compile: function () {
                return function (scope, elm, attr) {
                    console.log(attr.$attr["page-num"]);
                    $http({
                        // url: 'http://heekei.cn/api/get_posts/?count=100',
                        url: 'http://heekei.cn/wp-json/wp/v2/posts?page=' + (attr.$attr["page-num"] ? attr.$attr["page-num"] : 1),
                        method: 'GET',
                        cache: true
                    }).then(function (data) {
                        scope.data = data.data;
                    });
                };
            }
        };
    }])
    .directive('navbarDir', function () {
        return {
            restrict: "E",
            replace: true,
            templateUrl: 'views/navbar_tpl.html',
            controller: function ($scope) {
                $scope.treeOptions = {
                    nodeChildren: "children",
                    dirSelectable: true,
                    injectClasses: {
                        ul: "a1",
                        li: "a2",
                        liSelected: "a7",
                        iExpanded: "a3",
                        iCollapsed: "a4",
                        iLeaf: "a5",
                        label: "a6",
                        labelSelected: "a8"
                    }
                };
                $scope.dataForTheTree = [
                    {
                        "name": "Joe", "age": "21", "children": [
                            { "name": "Smith", "age": "42", "children": [] },
                            {
                                "name": "Gary", "age": "21", "children": [
                                    {
                                        "name": "Jenifer", "age": "23", "children": [
                                            { "name": "Dani", "age": "32", "children": [] },
                                            { "name": "Max", "age": "34", "children": [] }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    { "name": "Albert", "age": "33", "children": [] },
                    { "name": "Ron", "age": "29", "children": [] }
                ];
            }
        };
    })
    .directive('footerDir', function () {
        return {
            restrict: "E",
            replace: true,
            templateUrl: 'views/footer_tpl.html'
        };
    })

    ;

/**
 * about.js
 */
'use strict';
angular.module('aboutModule', [])
    .config(['$stateProvider', function ($stateProvider) {
        $stateProvider
            .state('about', {
                url: '/about',
                title: '关于',
                templateUrl: 'views/about.html'
            })
            ;

    }])
    .controller('aboutController', ['$scope'], function ($scope) { })
    ;
/**
 * main.js
 */
'use strict';
angular.module('ApiModule', [])
    .service('get_pages_by_cateid', ['$http', function ($http) {
        return function (id, pageid, callback) {
            $http({
                url: 'http://heekei.cn/wp-json/wp/v2/posts?categories=' + id + '&page=' + (pageid ? pageid : 1),
                method: 'GET',
                cache: true
            }).then(function (data) {
                callback(data.data);
            }, function (error) {
                console.error(error);
            });
        };
    }])
    .service('get_pages', ['$http', function ($http) {
        return function (id, callback) {
            $http({
                url: 'http://heekei.cn/wp-json/wp/v2/posts?page=' + id,
                method: 'GET',
                cache: true
            }).then(function (data) {
                callback(data.data);
            }, function (error) {
                console.error(error);
            });
        };
    }])
    .service('get_post', ['$http', function ($http) {
        return function (id, callback) {
            $http({
                // url: 'http://heekei.cn/api/get_post/?id=' + id,
                url: 'http://heekei.cn/wp-json/wp/v2/posts/' + id,
                method: 'GET',
                cache: true
            }).then(function (data) {
                data = data.data;
                // return callback(data);
                $http({
                    url: 'http://heekei.cn/api/get_post/?id=' + id,
                    // url: 'http://heekei.cn/wp-json/wp/v2/posts/' + id,
                    method: 'GET',
                    ignoreLoadingBar: true,
                    cache: true
                }).then(function (data2) {
                    data2 = data2.data;
                    data.previous_url = data2.previous_url;
                    data.next_url = data2.next_url;
                    return callback(data);
                }, function (err) {
                    console.error(err);
                });
            });
        };
    }])
    .directive('getCategoriesByPid', function () {
        return {
            restrict: 'E',
            templateUrl: 'views/category_tpl.html',
            controller: ['$scope', '$http', function ($scope, $http) {
                $http({
                    url: 'http://heekei.cn/wp-json/wp/v2/categories?post=' + $scope.pid,
                    method: 'GET',
                    ignoreLoadingBar: true,
                    cache: true
                }).then(function (res) {
                    $scope.categories = res.data;
                }, function (err) { console.error(err); });
            }]
        };
    })
    ;
angular.module('CategoriesModule', ['ApiModule'])
    .controller('CategoriesController', ['$rootScope', '$stateParams', '$scope', 'get_pages_by_cateid', function ($rootScope, $stateParams, $scope, get_pages_by_cateid) {
        // console.log($stateParams.id);
        $scope.caller = 'category';
        $scope.cid = $stateParams.cid;
        $scope.pageid = $stateParams.pageid || 1;
        get_pages_by_cateid($scope.cid, $scope.pageid, function (data) {
            $scope.data = data;
            // $rootScope.$state.current.title = $scope.article.title.rendered;
        });
    }]
    );

angular.module('PostPageModule', ['ApiModule'])
    .controller('postView', ['$rootScope', '$stateParams', '$scope', 'get_post', function ($rootScope, $stateParams, $scope, get_post) {
        $scope.pid = $stateParams.pid;
        $scope.pageid = $stateParams.pageid || 1;
        get_post($scope.pid, function (data) {
            $scope.article = data;
            $rootScope.$state.current.title = $scope.article.title.rendered;
            if (data.previous_url) {
                var startIndex = data.previous_url.toString().lastIndexOf('/') + 1;
                var lastIndex = data.previous_url.length - 5;
                $scope.prevUrl = data.previous_url.toString().substr(startIndex, lastIndex - startIndex);
            }
            if (data.next_url) {
                var startIndex2 = data.next_url.toString().lastIndexOf('/') + 1;
                var lastIndex2 = data.next_url.length - 5;
                $scope.nextUrl = data.next_url.toString().substr(startIndex2, lastIndex2 - startIndex2);
            }
        });
    }]
    );

angular.module('PagesModule', ['ApiModule'])
    .controller('PagesController', ['$stateParams', '$scope', 'get_pages', '$rootScope', '$state', function ($stateParams, $scope, get_pages, $rootScope, $state) {
        $scope.caller = 'page';
        $scope.pageid = ($stateParams.pageid && $stateParams.pageid >= 1) ? $stateParams.pageid : 1;
        $rootScope.$state.current.title = "第" + $scope.pageid + "页 - Heekei's Blog";
        get_pages($scope.pageid, function (data) {
            $scope.data = data;
            // $router
        });
    }]
    );