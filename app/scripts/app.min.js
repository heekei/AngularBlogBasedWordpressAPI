'use strict';
angular.module('blogOnAngularJsApp', [
    'ngAnimate',
    'ngCookies',
    'ngResource',
    'ngSanitize',
    'ngTouch',
    'ui.router',
    'treeControl',
    'ui.bootstrap',
    'angular-loading-bar',
    'PostPageModule',
    'PagesModule',
    'categoriesModule',
    'aboutModule',
    'linksModule'
])
    /*博客配置信息*/
    .run(['$rootScope', '$state', '$stateParams',
        function ($rootScope, $state, $stateParams) {
            $rootScope.$state = $state;
            $rootScope.$stateParams = $stateParams;
            $rootScope.siteConfig = {
                title: 'Heekei\'s Blog',
                description: '庄希琦的博客'
            };
            $rootScope.API = {
                get_post: 'https://www.heekei.cn/api/get_post/',
                get_posts: 'https://www.heekei.cn/api/get_posts/',
                get_category_posts: 'https://www.heekei.cn/api/get_category_posts/'
            };
        }
    ])
    .config(['$locationProvider', '$stateProvider', '$urlRouterProvider', 'cfpLoadingBarProvider', function ($locationProvider, $stateProvider, $urlRouterProvider, cfpLoadingBarProvider) {
        cfpLoadingBarProvider.spinnerTemplate = '<div><span class="fa fa-spinner"><div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div></div>';
        // $locationProvider.html5Mode(true);
        $locationProvider.hashPrefix('');
        $urlRouterProvider
            .when('', '/')
            .when('/post', '/')
            .otherwise('/NotFound');
        $stateProvider
            /*首页*/
            .state('home', {
                url: '/',
                title: '首页',
                controller: ['$state', function ($state) {
                    $state.go('page', { pageid: 1 }, { location: false });
                }]
            })
            /*分类页面*/
            .state('category', {
                url: '/category?cid&pageid',
                templateUrl: 'views/pages.html',
                controller: 'CategoriesController'
            })
            /*文章列表*/
            .state('page', {
                url: '/page?pageid',
                templateUrl: 'views/pages.html',
                controller: 'PagesController'
            })
            /*文章页*/
            .state('post', {
                url: '/post/{pid}',
                templateUrl: 'views/post_tpl.html',
                controller: 'postView'
            })
            /*404页面*/
            .state('NotFound', {
                url: '/NotFound',
                templateUrl: '404.html'
            })
            ;
    }])
    .directive('navbarDir', function () {
        return {
            restrict: 'E',
            replace: true,
            templateUrl: 'views/navbar_tpl.html',
            controller: function ($scope) {
                $scope.treeOptions = {
                    nodeChildren: 'children',
                    dirSelectable: true,
                    injectClasses: {
                        ul: 'a1',
                        li: 'a2',
                        liSelected: 'a7',
                        iExpanded: 'a3',
                        iCollapsed: 'a4',
                        iLeaf: 'a5',
                        label: 'a6',
                        labelSelected: 'a8'
                    }
                };
                $scope.dataForTheTree = [
                    {
                        'name': 'Joe', 'age': '21', 'children': [
                            { 'name': 'Smith', 'age': '42', 'children': [] },
                            {
                                'name': 'Gary', 'age': '21', 'children': [
                                    {
                                        'name': 'Jenifer', 'age': '23', 'children': [
                                            { 'name': 'Dani', 'age': '32', 'children': [] },
                                            { 'name': 'Max', 'age': '34', 'children': [] }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    { 'name': 'Albert', 'age': '33', 'children': [] },
                    { 'name': 'Ron', 'age': '29', 'children': [] }
                ];
            }
        };
    })
    .directive('footerDir', function () {
        return {
            restrict: 'E',
            replace: true,
            templateUrl: 'views/footer_tpl.html'
        };
    })

    ;

'use strict';
angular.module('aboutModule', [])
    .config(['$stateProvider', function ($stateProvider) {
        $stateProvider
            .state('about', {
                url: '/about',
                title: '关于',
                templateUrl: 'views/about.html'
            })
            ;

    }])
    .controller('aboutController', ['$scope'], function ($scope) { })
    ;
'use strict';
angular.module('linksModule', [])
    .config(['$stateProvider', function ($stateProvider) {
        $stateProvider
            .state('links', {
                url: '/links',
                title: '友情链接',
                templateUrl: 'views/links.html',
                controller: 'linksController'
            })
            ;

    }])
    .controller('linksController', ['$scope', '$http', function ($scope, $http) {
        $http({
            url: '/data/links.json',
            method: 'GET',
            cache: true
        }).then(function (data) {
            $scope.links = data.data;
        })
            ;
    }])
    ;
'use strict';
angular.module('ApiModule', [])
    .service('get_pages_by_cateid', ['$http', '$rootScope', '$state', function ($http, $rootScope, $state) {
        return function (id, pageid, callback) {
            $http({
                url: $rootScope.API.get_category_posts + '?count=10&id=' + id + '&page=' + (pageid ? pageid : 1),
                method: 'GET',
                cache: true
            }).then(function (data) {
                callback(data.data);
            }, function (error) {
                $state.go('NotFound', {
                    error: error
                });
            });
        };
    }])
    .service('get_pages', ['$http', '$rootScope', '$state', function ($http, $rootScope, $state) {
        return function (id, callback) {
            $http({
                url: $rootScope.API.get_posts + '?count=10&page=' + id,
                method: 'GET',
                cache: true
            }).then(function (data) {
                callback(data.data);
            }, function (error) {
                $state.go('NotFound', {
                    error: error
                });
            });
        };
    }])
    .service('get_post', ['$http', '$rootScope', '$state', function ($http, $rootScope, $state) {
        return function (id, callback) {
            $http({
                url: $rootScope.API.get_post + '?id=' + id,
                method: 'GET',
                cache: true
            }).then(function (data) {
                data = data.data;
                return callback(data);
            }, function (error) {
                $state.go('NotFound', {
                    error: error
                });
            });
        };
    }])
    ;
angular.module('categoriesModule', ['ApiModule'])
    .controller('CategoriesController', ['$rootScope', '$stateParams', '$scope', 'get_pages_by_cateid', '$timeout', function ($rootScope, $stateParams, $scope, get_pages_by_cateid, $timeout) {
        function reqPage() {
            $stateParams.pageid = $scope.pageid;
            get_pages_by_cateid($scope.cid, $scope.pageid, function (data) {
                $scope.data = data;
                $scope.PagerInfo = {
                    count: data.count,//当前页文章数量
                    count_per_page: 10,//每页显示文章数量
                    count_total: data.category.post_count,//所有文章数量
                    pages: data.pages,//所有页数
                    curPage: $scope.pageid//当前页
                };
                $rootScope.$state.current.title = '分类 - ' + data.category.title;
                $timeout(function () {
                    angular.element('.read-more').remove();
                });
            });
        }
        $scope.cid = $stateParams.cid;
        $scope.pageid = $stateParams.pageid || 1;
        $scope.jumpToPage = function () {
            $scope.data = {};//发起请求前清空数据
            reqPage();
        };
        reqPage();

    }]
    );

angular.module('PostPageModule', ['ApiModule'])
    .controller('postView', ['$rootScope', '$stateParams', '$scope', 'get_post', function ($rootScope, $stateParams, $scope, get_post) {
        $scope.pid = $stateParams.pid;
        $scope.pageid = $stateParams.pageid || 1;
        get_post($scope.pid, function (data) {
            $scope.article = data.post;
            $rootScope.$state.current.title = $scope.article.title;
            if (data.previous_url) {
                var startIndex = data.previous_url.toString().lastIndexOf('/') + 1;
                var lastIndex = data.previous_url.length - 5;
                $scope.prevUrl = data.previous_url.toString().substr(startIndex, lastIndex - startIndex);
            }
            if (data.next_url) {
                var startIndex2 = data.next_url.toString().lastIndexOf('/') + 1;
                var lastIndex2 = data.next_url.length - 5;
                $scope.nextUrl = data.next_url.toString().substr(startIndex2, lastIndex2 - startIndex2);
            }
        });
    }]
    );

angular.module('PagesModule', ['ApiModule'])
    .controller('PagesController', ['$stateParams', '$scope', 'get_pages', '$rootScope', '$state', '$timeout', function ($stateParams, $scope, get_pages, $rootScope, $state, $timeout) {
        function reqPage() {
            get_pages($scope.pageid, function (data) {
                $scope.data = data;
                $scope.PagerInfo = {
                    count: data.count,//当前页文章数量
                    count_total: data.count_total,//所有文章数量
                    count_per_page: 10,//每页显示文章数量
                    pages: data.pages,//所有页数
                    curPage: $scope.pageid//当前页
                };
                $rootScope.$state.current.title = '首页';
                $timeout(function () {
                    angular.element('.read-more').remove();
                });
            });
        }
        $scope.pageid = ($stateParams.pageid && $stateParams.pageid >= 1) ? $stateParams.pageid : 1;
        $scope.jumpToPage = function () {
            $scope.data = {};//发起请求前清空数据
            reqPage();
        };
        reqPage();

    }]
    );